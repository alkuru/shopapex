# Интеграция с API автозапчастей - Полная документация

## Обзор реализации

Полностью интегрирован внешний API автозапчастей в e-commerce backend на Django (ShopApex). Система поддерживает все ключевые методы API, обеспечивает полноценную панель управления в админке и веб-интерфейсе, а также реализует синхронизацию данных через систему поставщиков.

## Архитектура решения

### 1. Расширенная модель Supplier

Модель `Supplier` была значительно расширена для поддержки API автозапчастей:

#### Новые поля:
- `api_type` - тип API (custom/autoparts)
- `api_login` - логин для авторизации API
- `api_password` - пароль для авторизации API

#### Методы интеграции с API:
- `test_api_connection()` - тестирование соединения
- `search_products_by_article(article)` - поиск товаров по артикулу
- `sync_products()` - синхронизация товаров
- `get_staff_list()` - получение сотрудников
- `get_delivery_methods()` - получение способов доставки
- `get_order_statuses()` - получение статусов заказов
- `get_client_groups()` - получение групп клиентов
- `get_clients_list()` - получение клиентов
- `get_orders_list()` - получение заказов
- И множество других методов API

#### Методы синхронизации:
- `sync_staff()` - синхронизация сотрудников
- `sync_delivery_methods()` - синхронизация способов доставки
- `sync_order_statuses()` - синхронизация статусов
- `sync_client_groups()` - синхронизация групп клиентов
- `sync_clients()` - синхронизация клиентов
- `sync_orders()` - синхронизация заказов
- `sync_all_entities()` - полная синхронизация всех сущностей

### 2. Новые модели для сущностей API

Созданы специализированные модели для хранения данных из API:

#### Управление персоналом:
- `SupplierStaff` - сотрудники поставщика

#### Логистика:
- `SupplierDeliveryMethod` - способы доставки
- `SupplierOrderStatus` - статусы заказов

#### Клиентская база:
- `SupplierClientGroup` - группы клиентов
- `SupplierClient` - клиенты поставщика

#### Заказы и финансы:
- `SupplierOrder` - заказы
- `SupplierOrderItem` - позиции заказов
- `SupplierOrderHistory` - история изменений заказов
- `SupplierBalanceTransaction` - транзакции по балансу

### 3. API и сериализаторы

#### REST API endpoints:
```
/api/suppliers/ - управление поставщиками
/api/supplier-staff/ - сотрудники
/api/supplier-delivery-methods/ - способы доставки
/api/supplier-order-statuses/ - статусы заказов
/api/supplier-client-groups/ - группы клиентов
/api/supplier-clients/ - клиенты
/api/supplier-orders/ - заказы
/api/supplier-balance-transactions/ - транзакции
```

#### Дополнительные действия для поставщиков:
- `POST /api/suppliers/{id}/test_api/` - тест API
- `POST /api/suppliers/{id}/sync_products/` - синхронизация товаров
- `POST /api/suppliers/{id}/sync_entities/` - синхронизация всех сущностей
- `POST /api/suppliers/{id}/search_products/` - поиск товаров
- `GET /api/suppliers/{id}/staff/` - получение сотрудников
- `GET /api/suppliers/{id}/clients/` - получение клиентов
- `GET /api/suppliers/{id}/orders/` - получение заказов

### 4. Административная панель

#### Расширенная админка Supplier:
- Поддержка новых полей (api_type, api_login, api_password)
- Кнопки для всех типов синхронизации:
  - "Синхронизация товаров" - только товары
  - "Полная синхронизация" - все сущности сразу
  - "Синхронизация сущностей" - выборочная синхронизация

#### Новые административные интерфейсы:
- `SupplierStaffAdmin` - управление сотрудниками
- `SupplierDeliveryMethodAdmin` - управление доставкой
- `SupplierOrderStatusAdmin` - управление статусами
- `SupplierClientGroupAdmin` - управление группами клиентов
- `SupplierClientAdmin` - управление клиентами
- `SupplierOrderAdmin` - управление заказами
- `SupplierBalanceTransactionAdmin` - управление транзакциями

### 5. Веб-интерфейс для менеджеров

#### Основные страницы:
- `/catalog/supplier/{id}/entities/` - обзор интеграции
- `/catalog/supplier/{id}/staff/` - сотрудники поставщика
- `/catalog/supplier/{id}/clients/` - клиенты поставщика
- `/catalog/supplier/{id}/orders/` - заказы поставщика
- `/catalog/supplier/{id}/search/` - поиск товаров по API

#### Функциональность:
- Статистика по всем сущностям
- Фильтрация и поиск по всем спискам
- Пагинация для больших объемов данных
- Возможность запуска синхронизации из веб-интерфейса
- Поиск товаров по артикулу с отображением результатов

## Поддерживаемые методы API

### Поиск товаров
- ✅ GET /panel/parts/search/{article} - поиск брендов по артикулу
- ✅ GET /panel/parts/search/{article}/{brand} - поиск товаров по бренду и артикулу

### Сотрудники
- ✅ GET /panel/manager - получение списка сотрудников

### Способы доставки
- ✅ GET /panel/order/shipping_type - получение способов доставки
- ✅ POST /panel/order/shipping_type - добавление способа доставки
- ✅ POST /panel/order/shipping_type/{id} - изменение способа доставки
- ✅ POST /panel/order/remove_shipping_type - удаление способа доставки

### Статусы заказов
- ✅ GET /panel/order/status - получение статусов заказов
- ✅ POST /panel/order/status - добавление статуса
- ✅ POST /panel/order/status/{id} - изменение статуса
- ✅ POST /panel/order/remove_status - удаление статуса

### Группы клиентов
- ✅ GET /panel/client/group - получение групп клиентов
- ✅ POST /panel/client/group_form - добавление группы
- ✅ POST /panel/client/group_form/{id} - изменение группы
- ✅ POST /panel/client/remove_group - удаление группы

### Работа с клиентами
- ✅ GET /panel/client - получение списка клиентов (с фильтрами)
- ✅ GET /panel/client/form/{id} - получение расширенных данных клиента
- ✅ POST /panel/client/form - создание клиента
- ✅ POST /panel/client/form/{id} - изменение клиента

### Работа с балансами
- ✅ GET /panel/client/balance/{id} - получение операций с балансом
- ✅ GET /panel/client/add_transaction/{id} - добавление операции

### Работа с заказами
- ✅ GET /panel/order - получение списка заказов (с фильтрами)
- ✅ POST /panel/order/set_status/{id} - изменение статуса позиции
- ✅ GET /panel/order/deny/{id} - снятие позиции
- ✅ GET /panel/order/pay/{id} - оплата/снятие оплаты позиции
- ✅ GET /panel/order/archive/{id} - добавление в архив
- ✅ GET /panel/order/unarchive/{id} - снятие из архива
- ✅ GET /panel/order/documents/{ids} - создание документов

## Использование системы

### 1. Настройка поставщика

1. В админ-панели перейдите в `Каталог > Поставщики`
2. Создайте нового поставщика или отредактируйте существующего
3. Установите:
   - `Тип API`: "API автозапчастей"
   - `URL API`: адрес API поставщика
   - `Логин API`: логин для авторизации
   - `Пароль API`: пароль для авторизации

### 2. Тестирование соединения

Используйте кнопку "Тест API" в админке или веб-интерфейсе для проверки подключения.

### 3. Синхронизация данных

#### Из админки:
- "Синхронизация товаров" - только товары
- "Полная синхронизация" - все сущности
- "Синхронизация сущностей" - выборочная синхронизация

#### Из веб-интерфейса:
- Перейдите в раздел "Интеграция API" для поставщика
- Выберите тип синхронизации и нажмите "Синхронизировать"

### 4. Поиск товаров

1. Перейдите в раздел "Интеграция API" > "Поиск товаров по артикулу"
2. Введите артикул и нажмите "Поиск"
3. Система покажет доступные бренды и товары с ценами и наличием

### 5. Работа с сущностями

- **Сотрудники**: просмотр информации о персонале поставщика
- **Клиенты**: управление клиентской базой с фильтрацией по группам и менеджерам
- **Заказы**: отслеживание заказов с историей изменений статусов

## Технические особенности

### Авторизация
Система использует HTTP Basic Authentication с логином и паролем, переданными через заголовок Authorization.

### Обработка ошибок
- Все методы API возвращают структурированные ответы с флагом success
- Подробные сообщения об ошибках логируются в SupplierSyncLog
- Graceful handling неработающих API или некорректных данных

### Производительность
- Используются select_related и prefetch_related для оптимизации запросов
- Пагинация для больших списков
- Батчевые операции при синхронизации
- Кэширование связанных объектов

### Безопасность
- Проверка типа API перед выполнением операций
- Валидация всех входящих данных
- Защита от SQL-инъекций через ORM Django
- Ограничение доступа к админским функциям

## Мониторинг и логирование

### SupplierSyncLog
Все операции синхронизации записываются в лог с информацией:
- Поставщик
- Статус операции (in_progress, completed, error)
- Количество созданных/обновленных/ошибочных записей
- Подробное сообщение
- Время выполнения

### Веб-интерфейс мониторинга
- Статистика по всем сущностям на главной странице интеграции
- История операций синхронизации
- Статус API подключения в списке поставщиков

## Расширяемость

Архитектура решения позволяет легко:
- Добавлять новые методы API
- Создавать новые модели для дополнительных сущностей
- Расширять веб-интерфейс новыми страницами
- Интегрировать с другими типами API поставщиков

## Заключение

Реализована полноценная интеграция с API автозапчастей, которая включает:

✅ **Все методы API**: поиск, сотрудники, доставка, статусы, клиенты, заказы, балансы  
✅ **Полную админку**: управление всеми сущностями с удобным интерфейсом  
✅ **Веб-интерфейс**: для менеджеров с фильтрацией, поиском и пагинацией  
✅ **Автоматическую синхронизацию**: как полную, так и выборочную  
✅ **Мониторинг**: логирование операций и отображение статистики  
✅ **REST API**: для внешних интеграций и мобильных приложений  

Система готова к продуктивному использованию и может быть легко расширена для поддержки дополнительной функциональности.
