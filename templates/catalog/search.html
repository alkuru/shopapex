{% extends "base.html" %}
{% load brand_extras %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<style>
  .main-article-td {
    background: #F5F5DC !important;
  }
  .custom-black-border {
    border: 3px solid #696969 !important;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .main-article-row {
    border-top: 4px solid #696969 !important;
    border-bottom: 4px solid #696969 !important;
    background: #F5F5DC !important;
  }
  .analogs-label-row td {
    border-top: 4px solid #696969 !important;
    border-bottom: 4px solid #696969 !important;
    background: #A9A9A9 !important;
    font-weight: bold;
    font-size: 1.1em;
    color: #fff !important;
    text-align: left;
    letter-spacing: 1px;
  }
  .table thead th {
    border-top: 4px solid #696969 !important;
    border-bottom: 4px solid #696969 !important;
    background: #A9A9A9 !important;
    color: #fff !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
    height: 20px;
    padding: 0 4px;
  }
  .table {
    table-layout: fixed;
    width: 100%;
    font-size: 13px;
  }
  .table th, .table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    height: 20px;
    vertical-align: middle;
    padding: 0 4px;
    font-size: 13px;
  }
  .table th:nth-child(1), .table td:nth-child(1) { width: 90px; }
  .table th:nth-child(2), .table td:nth-child(2) { width: 180px; }
  .table th:nth-child(3), .table td:nth-child(3) { width: 220px; }
  .table th:nth-child(4), .table td:nth-child(4) { width: 50px; }
  .table th:nth-child(5), .table td:nth-child(5) { width: 40px; }
  .table th:nth-child(6), .table td:nth-child(6) { width: 160px; }
  .table th:nth-child(7), .table td:nth-child(7) { width: 90px; }
  .table th:nth-child(8), .table td:nth-child(8) { width: 90px; }
  .table thead th a,
  .table thead th a:visited,
  .table thead th a:active {
    color: #fff !important;
    text-decoration: underline;
  }
  .table thead th a:hover {
    color: #e0e0e0 !important;
  }
  .analog-row {
    background: #f7faff !important;
  }
  .search-btn-custom {
    background: #F08080 !important;
    border-color: #F08080 !important;
    color: #fff !important;
  }
  .search-btn-custom:hover, .search-btn-custom:focus {
    background: #e06666 !important;
    border-color: #e06666 !important;
    color: #fff !important;
  }
  .cart-btn-custom {
    background: #fff !important;
    border: 2px solid #000 !important;
    color: #000 !important;
    border-radius: 6px !important;
    padding: 4px 8px !important;
    font-size: 12px !important;
    min-width: 32px !important;
    height: 32px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  .cart-btn-custom:hover, .cart-btn-custom:focus {
    background: #f8f9fa !important;
    border-color: #000 !important;
    color: #000 !important;
  }
  
  /* Стили для фильтров */
  #brandFilter, #ratingFilter, #priceFilter {
    width: 240px !important;
    max-width: 240px !important;
    min-width: 240px !important;
  }
  #brandFilter, #ratingFilter, #priceFilter {
    border-color: #000 !important;
  }
  #brandFilter:focus, #ratingFilter:focus, #priceFilter:focus {
    border-color: #000 !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25) !important;
  }
  
  /* Стили для кнопки гаража */
  .garage-btn-ultra-custom,
  .orders-btn-ultra-custom,
  .big-cart-btn-ultra-custom {
    font-size: 1rem !important;
    padding: 2rem 3rem !important;
    border: 2px solid #000 !important;
    border-radius: 8px !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    height: 100px !important;
    width: 250px !important;
    background-color: #fff !important;
    color: #000 !important;
    font-weight: 500 !important;
    box-sizing: border-box !important;
    margin: 10px 16px 10px 0 !important;
    transition: background 0.15s, border 0.15s;
  }
  .garage-btn-ultra-custom:hover,
  .orders-btn-ultra-custom:hover,
  .big-cart-btn-ultra-custom:hover {
    background-color: #f8f9fa !important;
    border: 3px solid #000 !important;
    color: #000 !important;
    text-decoration: none !important;
  }
  .garage-btn-ultra-custom img {
    width: 45px !important;
    height: 45px !important;
    margin-right: 12px !important;
    object-fit: cover !important;
  }
  /* Стили для flip-эффекта кнопки гаража */
  .garage-btn-flip {
    perspective: 1000px;
    display: inline-block;
    margin: 10px 16px 10px 0 !important;
  }
  .garage-btn-flip-inner {
    position: relative;
    width: 250px;
    height: 100px;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .garage-btn-flip:hover .garage-btn-flip-inner {
    transform: rotateY(180deg);
  }
  .garage-btn-flip .front,
  .garage-btn-flip .back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #d00 !important;
    border-radius: 18px !important;
    outline: 4px solid #000 !important;
    outline-offset: 3px !important;
    background-color: #fff !important;
    color: #000 !important;
    font-weight: 500 !important;
    box-sizing: border-box !important;
    text-decoration: none !important;
    box-shadow: 0 6px 32px 0 rgba(0,0,0,0.22), 0 2px 8px 0 rgba(220,0,0,0.18);
  }
  .garage-btn-flip .front {
    flex-direction: row;
    padding: 2rem 3rem !important;
  }
  .garage-btn-flip .back {
    transform: rotateY(180deg);
    flex-direction: column;
    padding: 1rem !important;
    font-size: 0.72rem !important;
    text-align: center;
  }
  .garage-btn-flip .back .garage-instruction {
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }
  .garage-btn-flip .back .garage-instruction b {
    display: block;
    margin-top: 0;
    margin-bottom: 0.12rem;
    font-size: 0.68rem !important;
    font-weight: 600;
  }
  .garage-btn-flip .back .garage-instruction ul {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
    font-size: 0.7rem;
  }
  .garage-btn-flip .back .garage-instruction li {
    margin: 0.2rem 0;
  }
  .garage-btn-flip .back .btn {
    font-size: 0.7rem !important;
    padding: 0.3rem 0.8rem !important;
    border: 1px solid #000 !important;
    background: #000 !important;
    color: #fff !important;
    text-decoration: none !important;
    border-radius: 4px !important;
  }
  .garage-btn-flip .back .btn:hover {
    background: #333 !important;
  }
  .orders-btn-flip {
    perspective: 1000px;
    display: inline-block;
    margin: 10px 16px 10px 0 !important;
  }
  .orders-btn-flip-inner {
    position: relative;
    width: 250px;
    height: 100px;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .orders-btn-flip:hover .orders-btn-flip-inner {
    transform: rotateY(180deg);
  }
  .orders-btn-flip .front,
  .orders-btn-flip .back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #d00 !important;
    border-radius: 18px !important;
    outline: 4px solid #000 !important;
    outline-offset: 3px !important;
    background-color: #fff !important;
    color: #000 !important;
    font-weight: 500 !important;
    box-sizing: border-box !important;
    text-decoration: none !important;
    box-shadow: 0 6px 32px 0 rgba(0,0,0,0.22), 0 2px 8px 0 rgba(220,0,0,0.18);
  }
  .orders-btn-flip .front {
    flex-direction: row;
    padding: 2rem 3rem !important;
  }
  .orders-btn-flip .back {
    transform: rotateY(180deg);
    flex-direction: column;
    padding: 1rem !important;
    font-size: 0.72rem !important;
    text-align: center;
  }
  .orders-btn-flip .back .orders-instruction {
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }
  .orders-btn-flip .back .orders-instruction ul {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
    font-size: 0.7rem;
  }
  .orders-btn-flip .back .orders-instruction li {
    margin: 0.2rem 0;
  }
  .orders-btn-flip .back .btn {
    font-size: 0.7rem !important;
    padding: 0.3rem 0.8rem !important;
    border: 1px solid #000 !important;
    background: #000 !important;
    color: #fff !important;
    text-decoration: none !important;
    border-radius: 4px !important;
  }
  .orders-btn-flip .back .btn:hover {
    background: #333 !important;
  }
  .big-cart-btn-flip {
    perspective: 1000px;
    display: inline-block;
    margin: 10px 0 10px 0 !important;
  }
  .big-cart-btn-flip-inner {
    position: relative;
    width: 250px;
    height: 100px;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .big-cart-btn-flip:hover .big-cart-btn-flip-inner {
    transform: rotateY(180deg);
  }
  .big-cart-btn-flip .front,
  .big-cart-btn-flip .back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #c44 !important;
    border-radius: 18px !important;
    outline: 4px solid #000 !important;
    outline-offset: 3px !important;
    background-color: #fff !important;
    color: #000 !important;
    font-weight: 500 !important;
    box-sizing: border-box !important;
    text-decoration: none !important;
    box-shadow: 0 6px 32px 0 rgba(0,0,0,0.22), 0 2px 8px 0 rgba(220,0,0,0.18);
  }
  .big-cart-btn-flip .front {
    flex-direction: row;
    padding: 2rem 3rem !important;
  }
  .big-cart-btn-flip .back {
    transform: rotateY(180deg);
    flex-direction: column;
    padding: 1rem !important;
    font-size: 0.72rem !important;
    text-align: center;
  }
  .big-cart-btn-flip .back .cart-instruction {
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }
  .big-cart-btn-flip .back .cart-instruction ul {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
    font-size: 0.7rem;
  }
  .big-cart-btn-flip .back .cart-instruction li {
    margin: 0.2rem 0;
  }
  .big-cart-btn-flip .back .btn {
    font-size: 0.7rem !important;
    padding: 0.3rem 0.8rem !important;
    border: 1px solid #000 !important;
    background: #000 !important;
    color: #fff !important;
    text-decoration: none !important;
    border-radius: 4px !important;
  }
  .big-cart-btn-flip .back .btn:hover {
    background: #333 !important;
  }
</style>
<div class="container my-4">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'catalog_web:home' %}">Каталог</a></li>
                    <li class="breadcrumb-item active">Поиск</li>
                </ol>
            </nav>
            
            <!-- Форма поиска -->
            <div class="d-flex align-items-center mb-3" style="gap: 32px;">
                <form method="get" style="flex: 0 1 400px;">
                    <div class="input-group" style="max-width: 400px; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <input type="text" name="q" class="form-control" placeholder="Введите артикул, название, VIN или номер кузова" value="{{ query }}" required style="background-color: #f5f5f5; border: 1px solid #6c757d; border-right: none; border-radius: 0; outline: none;">
                        <button type="submit" class="btn" style="background-color: #6c757d; color: white; border: 1px solid #6c757d; border-radius: 0; padding: 8px 12px; outline: none;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
                {% if user.is_authenticated %}
                <div class="garage-btn-flip">
                  <div class="garage-btn-flip-inner">
                    <div class="front">
                      <img src="{% static 'images/garage-icon.jpg' %}?v=20" alt="Гараж" style="width: 90px !important; height: 90px !important; margin-right: 20px !important; object-fit: cover !important; display: block !important; max-width: none !important; max-height: none !important;">
                      Мой гараж
                    </div>
                    <div class="back">
                      <div class="garage-instruction">
                        <ul>
                          <li>• Добавьте VIN вашего авто</li>
                          <li>• Сохраняйте несколько машин</li>
                          <li>• Быстрый доступ к своим авто</li>
                        </ul>
                        <a href="{% url 'accounts_web:garage_page' %}" class="btn">Перейти в гараж</a>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="orders-btn-flip">
                  <div class="orders-btn-flip-inner">
                    <div class="front">
                      <img src="{% static 'images/orders-icon.jpg' %}?v=1" alt="Заказы" style="width: 90px !important; height: 90px !important; margin-right: 20px !important; object-fit: cover !important; display: block !important; max-width: none !important; max-height: none !important;">
                      Заказы
                    </div>
                    <div class="back">
                      <div class="orders-instruction">
                        <ul>
                          <li>• Просматривайте все свои заказы</li>
                          <li>• Следите за статусом выполнения</li>
                          <li>• Повторяйте заказы в один клик</li>
                        </ul>
                        <a href="{% url 'orders_web:orders_page' %}" class="btn">Перейти к заказам</a>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="big-cart-btn-flip">
                  <div class="big-cart-btn-flip-inner">
                    <div class="front">
                      <img src="{% static 'images/cart-icon.jpg' %}?v=1" alt="Корзина" style="width: 90px !important; height: 90px !important; margin-right: 20px !important; object-fit: cover !important; display: block !important; max-width: none !important; max-height: none !important;">
                      Корзина
                    </div>
                    <div class="back">
                      <div class="cart-instruction">
                        <ul>
                          <li>• Добавляйте товары в корзину</li>
                          <li>• Изменяйте количество и удаляйте позиции</li>
                          <li>• Оформляйте заказ в один клик</li>
                        </ul>
                        <a href="{% url 'catalog_web:cart' %}" class="btn">Перейти в корзину</a>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
            </div>
            
            {% if query %}
                <div class="mb-3">
                  <span class="alert alert-info d-inline-block mb-0" style="border:none;background:#F5F5DC;color:#222;padding:0.3em 0.8em; font-size:0.9rem; max-width: 400px;">
                    <i class="fas fa-search"></i> Результаты поиска по артикулу: "<strong>{{ query }}</strong>"
                  </span>
                </div>
                
                <!-- Фильтры -->
                {% if groups and groups|length > 0 %}
                <div class="mb-3 d-flex">
                    <div class="me-5" style="margin-right: 4rem !important;">
                        <label for="brandFilter" class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; font-size: 0.8rem;">Бренд:</label>
                        <select id="brandFilter" class="form-select" style="max-width: 240px; background-color: #f8f9fa; border: 1px solid #000; border-radius: 4px; font-size: 0.7rem; padding: 0.3rem 0.5rem; width: 240px !important;">
                            <option value="">ВСЕ ПРОИЗВОДИТЕЛИ</option>
                            {% for brand in unique_brands %}
                                <option value="{{ brand }}" {% if selected_brand == brand %}selected{% endif %}>{{ brand }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="margin-left: 2rem;">
                        <label for="ratingFilter" class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; font-size: 0.8rem;">Рейтинг бренда:</label>
                        <select id="ratingFilter" class="form-select" style="max-width: 240px; background-color: #f8f9fa; border: 1px solid #000; border-radius: 4px; font-size: 0.7rem; padding: 0.3rem 0.5rem; width: 240px !important;">
                            <option value="">ВСЕ РЕЙТИНГИ</option>
                            <option value="5">5 премиум</option>
                            <option value="4">4 хорошее</option>
                            <option value="3">3 средний</option>
                            <option value="2">2 низкий</option>
                            <option value="1">1 плохой</option>
                        </select>
                    </div>
                    
                    <div style="margin-left: 2rem;">
                        <label for="priceFilter" class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; font-size: 0.8rem;">Цена:</label>
                        <select id="priceFilter" class="form-select" style="max-width: 240px; background-color: #f8f9fa; border: 1px solid #000; border-radius: 4px; font-size: 0.7rem; padding: 0.3rem 0.5rem; width: 240px !important;">
                            <option value="">ВСЕ ЦЕНЫ</option>
                            {% for price in unique_prices %}
                                <option value="{{ price }}">{{ price }} ₽</option>
                            {% endfor %}
                        </select>
                    </div>



                </div>
                {% endif %}
            {% else %}
                <h1 class="mb-4">{{ page_title }}</h1>
            {% endif %}
            
            <!-- Отладочная информация -->
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if show_brand_select %}
                <div class="alert alert-info">Выберите производителя для артикула <strong>{{ query }}</strong>:</div>
                <div class="table-responsive mb-4">
                  <table class="table table-bordered align-middle table-sm bg-white mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Производитель</th>
                        <th>Артикул</th>
                        <th>Наименование</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    {% for b in brands_list %}
                      <tr>
                        <td>{{ b.brand }}</td>
                        <td>{{ b.articul }}</td>
                        <td>{{ b.name }}</td>
                        <td>
                          <form method="get" style="display:inline;">
                            <input type="hidden" name="q" value="{{ query }}">
                            <input type="hidden" name="brand" value="{{ b.brand }}">
                            <button type="submit" class="btn btn-primary btn-sm">Выбрать</button>
                          </form>
                        </td>
                      </tr>
                    {% endfor %}
                    </tbody>
                  </table>
                </div>
            {% endif %}
                {% if groups and groups|length > 0 %}
                <div class="table-responsive">
                  {% for g in groups %}
                    {% if forloop.first %}
                      <table class="table table-bordered align-middle table-sm bg-white mb-4 offers-table">
                        <thead class="table-light">
                          <tr>
                            <th>Артикул</th>
                            <th>Бренд</th>
                            <th>Наименование</th>
                            <th>Наличие</th>
                            <th>Срок поставки</th>
                            <th>Склад</th>
                            <th>Цена</th>
                            <th>Корзина</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for p in g.visible %}
                          <tr>
                            <td>{{ p.article|default:"-" }}</td>
                            <td>
                              {% with flag=p.brand|brand_flag %}
                                {% if flag %}
                                  <img src="{% static 'flags/' %}{{ flag }}.svg" alt="{{ flag }}" title="{{ flag|upper }}" style="height:14px;vertical-align:middle;margin-right:4px;">
                                {% endif %}
                              {% endwith %}
                              <strong>{{ p.brand|default:"-" }}</strong>
                              {% with rating=brand_ratings|get_item:p.brand %}
                                {% if rating %}
                                  <span style="margin-left:4px;vertical-align:middle;">{{ rating|brand_rating_stars|safe }}</span>
                                {% endif %}
                              {% endwith %}
                            </td>
                            <td>{{ p.name|default:"-"|truncatechars:60 }}</td>
                            <td>{{ p.stock_quantity|default:"-" }}</td>
                            <td>{{ p.delivery_time|default:"-" }}</td>
                            <td>{{ p.price_label|default:p.warehouse|default:"-" }}</td>
                            <td><strong>{{ p.price|default:"-" }} ₽</strong></td>
                            <td>
                              <button class="btn btn-primary cart-btn-custom" onclick="addToCart('{{ p.article|default:'' }}')">
                                <img src="{% static 'images/cart-icon-mini.jpg' %}?v=1" alt="Корзина" style="width: 20px !important; height: 20px !important; object-fit: cover !important;">
                              </button>
                            </td>
                          </tr>
                          {% endfor %}
                          {% with key=g.articul|default_if_none:''|add:'__'|add:g.brand|default_if_none:''|slugify %}
                          <tr class="more-btn-row" data-group="{{ key }}">
                            <td colspan="8">
                              <button class="btn btn-outline-dark btn-sm show-more-btn" data-group="{{ key }}" style="font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">
                                ещё {{ g.hidden_shown|default:0 }} предложений
                              </button>
                              <button class="btn btn-outline-dark btn-sm brand-desc-btn" data-brand="{{ g.brand }}" style="margin-left:8px;font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">Описание бренда</button>
                              {% with website=brand_websites|get_item:g.brand %}
                                {% if website %}
                                  <a href="{{ website }}" target="_blank" class="btn btn-outline-dark btn-sm" style="margin-left:8px;font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">Официальный сайт</a>
                                {% endif %}
                              {% endwith %}
                              {% with catalog=brand_catalogs|get_item:g.brand %}
                                {% if catalog %}
                                  <a href="{{ catalog }}" target="_blank" class="btn btn-outline-dark btn-sm" style="margin-left:8px;font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">Онлайн каталог</a>
                                {% endif %}
                              {% endwith %}
                              <span class="brand-desc-text" data-brand="{{ g.brand }}" style="display:none;">{{ brand_descriptions|get_item:g.brand|default:''|linebreaksbr }}</span>
                            </td>
                          </tr>
                          {% for p in g.hidden %}
                          <tr class="hidden group-{{ key }}">
                            <td>{{ p.article|default:"-" }}</td>
                            <td>
                              {% with flag=p.brand|brand_flag %}
                                {% if flag %}
                                  <img src="{% static 'flags/' %}{{ flag }}.svg" alt="{{ flag }}" title="{{ flag|upper }}" style="height:14px;vertical-align:middle;margin-right:4px;">
                                {% endif %}
                              {% endwith %}
                              <strong>{{ p.brand|default:"-" }}</strong>
                              {% with rating=brand_ratings|get_item:p.brand %}
                                {% if rating %}
                                  <span style="margin-left:4px;vertical-align:middle;">{{ rating|brand_rating_stars|safe }}</span>
                                {% endif %}
                              {% endwith %}
                            </td>
                            <td>{{ p.name|default:"-"|truncatechars:60 }}</td>
                            <td>{{ p.stock_quantity|default:"-" }}</td>
                            <td>{{ p.delivery_time|default:"-" }}</td>
                            <td>{{ p.price_label|default:p.warehouse|default:"-" }}</td>
                            <td><strong>{{ p.price|default:"-" }} ₽</strong></td>
                            <td>
                              <button class="btn btn-primary cart-btn-custom" onclick="addToCart('{{ p.article|default:'' }}')">
                                <img src="{% static 'images/cart-icon-mini.jpg' %}?v=1" alt="Корзина" style="width: 20px !important; height: 20px !important; object-fit: cover !important;">
                              </button>
                            </td>
                          </tr>
                          {% endfor %}
                          <tr class="hidden collapse-btn-row group-{{ key }}" data-brand="{{ g.brand|escapejs }}">
                            <td colspan="8">
                              <button class="btn btn-outline-dark btn-sm collapse-btn" data-group="{{ key }}" style="font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">
                                свернуть
                              </button>
                            </td>
                          </tr>
                          {% endwith %}
                        </tbody>
                      </table>
                      {# Блок с надписью 'аналоги артикула ...' #}
                      <div style="border: 1px solid #d00; border-radius: 4px; background: #fff; color: #111; font-weight: bold; display: inline-block; padding: 2px 18px; margin: 10px 0 8px 0; font-size: 15px;">
                        аналоги артикула {{ g.articul }}
                      </div>
                    {% else %}
                      <table class="table table-bordered align-middle table-sm bg-white mb-4 offers-table">
                        <thead class="table-light">
                          <tr>
                            <th>Артикул</th>
                            <th>Бренд</th>
                            <th>Наименование</th>
                            <th>Наличие</th>
                            <th>Срок поставки</th>
                            <th>Склад</th>
                            <th>Цена</th>
                            <th>Корзина</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for p in g.visible %}
                          <tr>
                            <td>{{ p.article|default:"-" }}</td>
                            <td>
                              {% with flag=p.brand|brand_flag %}
                                {% if flag %}
                                  <img src="{% static 'flags/' %}{{ flag }}.svg" alt="{{ flag }}" title="{{ flag|upper }}" style="height:14px;vertical-align:middle;margin-right:4px;">
                                {% endif %}
                              {% endwith %}
                              <strong>{{ p.brand|default:"-" }}</strong>
                              {% with rating=brand_ratings|get_item:p.brand %}
                                {% if rating %}
                                  <span style="margin-left:4px;vertical-align:middle;">{{ rating|brand_rating_stars|safe }}</span>
                                {% endif %}
                              {% endwith %}
                            </td>
                            <td>{{ p.name|default:"-"|truncatechars:60 }}</td>
                            <td>{{ p.stock_quantity|default:"-" }}</td>
                            <td>{{ p.delivery_time|default:"-" }}</td>
                            <td>{{ p.price_label|default:p.warehouse|default:"-" }}</td>
                            <td><strong>{{ p.price|default:"-" }} ₽</strong></td>
                            <td>
                              <button class="btn btn-primary cart-btn-custom" onclick="addToCart('{{ p.article|default:'' }}')">
                                <img src="{% static 'images/cart-icon-mini.jpg' %}?v=1" alt="Корзина" style="width: 20px !important; height: 20px !important; object-fit: cover !important;">
                              </button>
                            </td>
                          </tr>
                          {% endfor %}
                          {% with key=g.articul|default_if_none:''|add:'__'|add:g.brand|default_if_none:''|slugify %}
                          <tr class="more-btn-row" data-group="{{ key }}">
                            <td colspan="8">
                              <button class="btn btn-outline-dark btn-sm show-more-btn" data-group="{{ key }}" style="font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">
                                ещё {{ g.hidden_shown|default:0 }} предложений
                              </button>
                              <button class="btn btn-outline-dark btn-sm brand-desc-btn" data-brand="{{ g.brand }}" style="margin-left:8px;font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">Описание бренда</button>
                              {% with website=brand_websites|get_item:g.brand %}
                                {% if website %}
                                  <a href="{{ website }}" target="_blank" class="btn btn-outline-dark btn-sm" style="margin-left:8px;font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">Официальный сайт</a>
                                {% endif %}
                              {% endwith %}
                              {% with catalog=brand_catalogs|get_item:g.brand %}
                                {% if catalog %}
                                  <a href="{{ catalog }}" target="_blank" class="btn btn-outline-dark btn-sm" style="margin-left:8px;font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">Онлайн каталог</a>
                                {% endif %}
                              {% endwith %}
                              <span class="brand-desc-text" data-brand="{{ g.brand }}" style="display:none;">{{ brand_descriptions|get_item:g.brand|default:''|linebreaksbr }}</span>
                            </td>
                          </tr>
                          {% for p in g.hidden %}
                          <tr class="hidden group-{{ key }}">
                            <td>{{ p.article|default:"-" }}</td>
                            <td>
                              {% with flag=p.brand|brand_flag %}
                                {% if flag %}
                                  <img src="{% static 'flags/' %}{{ flag }}.svg" alt="{{ flag }}" title="{{ flag|upper }}" style="height:14px;vertical-align:middle;margin-right:4px;">
                                {% endif %}
                              {% endwith %}
                              <strong>{{ p.brand|default:"-" }}</strong>
                              {% with rating=brand_ratings|get_item:p.brand %}
                                {% if rating %}
                                  <span style="margin-left:4px;vertical-align:middle;">{{ rating|brand_rating_stars|safe }}</span>
                                {% endif %}
                              {% endwith %}
                            </td>
                            <td>{{ p.name|default:"-"|truncatechars:60 }}</td>
                            <td>{{ p.stock_quantity|default:"-" }}</td>
                            <td>{{ p.delivery_time|default:"-" }}</td>
                            <td>{{ p.price_label|default:p.warehouse|default:"-" }}</td>
                            <td><strong>{{ p.price|default:"-" }} ₽</strong></td>
                            <td>
                              <button class="btn btn-primary cart-btn-custom" onclick="addToCart('{{ p.article|default:'' }}')">
                                <img src="{% static 'images/cart-icon-mini.jpg' %}?v=1" alt="Корзина" style="width: 20px !important; height: 20px !important; object-fit: cover !important;">
                              </button>
                            </td>
                          </tr>
                          {% endfor %}
                          <tr class="hidden collapse-btn-row group-{{ key }}" data-brand="{{ g.brand|escapejs }}">
                            <td colspan="8">
                              <button class="btn btn-outline-dark btn-sm collapse-btn" data-group="{{ key }}" style="font-size:10.7px;padding:1.8px 7.2px;height:19.8px;">
                                свернуть
                              </button>
                            </td>
                          </tr>
                          {% endwith %}
                        </tbody>
                      </table>
                    {% endif %}
                  {% endfor %}
                </div>
<style>
.hidden { display: none; }
.analog { color: red; font-weight: bold; }
</style>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-5x text-muted mb-3"></i>
                        <h3>Товары не найдены</h3>
                        <p class="text-muted">По запросу "{{ query }}" ничего не найдено. Попробуйте изменить поисковый запрос.</p>
                        <a href="{% url 'catalog_web:home' %}" class="btn btn-primary search-btn-custom">
                            <i class="fas fa-arrow-left"></i> Вернуться в каталог
                        </a>
                    </div>
                {% endif %}
        </div>
    </div>
</div>

{# Скрытые данные для JavaScript #}
<div id="brandWebsitesData" style="display:none;" data-websites="{{ brand_websites|escapejs }}"></div>
<div id="brandCatalogsData" style="display:none;" data-catalogs="{{ brand_catalogs|escapejs }}"></div>

{# Модальное окно для описания бренда #}
<div id="brandDescModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);">
  <div style="background:#fff;max-width:480px;margin:8vh auto;padding:24px 24px 16px 24px;border-radius:8px;box-shadow:0 2px 16px #0002;position:relative;">
    <button id="brandDescModalClose" style="position:absolute;right:12px;top:8px;font-size:20px;background:none;border:none;cursor:pointer;">&times;</button>
    <div id="brandDescModalContent" style="font-size:15px;line-height:1.5;"></div>
  </div>
</div>
<script>
function addToCart(productId) {
    // Заглушка для добавления в корзину
    alert('Товар добавлен в корзину! (ID: ' + productId + ')');
    // Здесь будет AJAX запрос к API для добавления товара в корзину
}
document.addEventListener('click', function (e) {
  if (e.target.classList.contains('show-more-btn')) {
    const key = e.target.dataset.group;
    const hiddenRows = document.querySelectorAll('.group-' + key + ':not(.collapse-btn-row)');
    if (hiddenRows.length > 0) {
      document.querySelectorAll('.group-' + key).forEach(tr => tr.classList.remove('hidden'));
      e.target.closest('tr').classList.add('hidden'); // скрываем кнопку "ещё предложений"
      // Добавляем обработчики к кнопкам "Описание бренда" после показа скрытых предложений
      addBrandDescHandlers();
    }
  }
  if (e.target.classList.contains('collapse-btn')) {
    const key = e.target.dataset.group;
    document.querySelectorAll('.group-' + key).forEach(tr => tr.classList.add('hidden'));
    // Показываем кнопку "ещё предложений" (она уже существует, просто скрыта)
    const moreBtnRow = document.querySelector('.more-btn-row[data-group="' + key + '"]');
    if (moreBtnRow) {
      moreBtnRow.classList.remove('hidden');
      // Добавляем обработчики к кнопкам "Описание бренда" после показа
      addBrandDescHandlers();
    }
    // НЕ удаляем кнопку "свернуть", просто скрываем её
    e.target.closest('tr').classList.add('hidden');
  }
});
// Функция для добавления обработчиков к кнопкам "Описание бренда"
function addBrandDescHandlers() {
  document.querySelectorAll('.brand-desc-btn').forEach(function(btn) {
    // Удаляем старые обработчики, если они есть
    btn.removeEventListener('click', brandDescClickHandler);
    // Добавляем новый обработчик
    btn.addEventListener('click', brandDescClickHandler);
  });
}

// Обработчик клика для кнопки "Описание бренда"
function brandDescClickHandler() {
  var brand = this.getAttribute('data-brand');
  
  // Ищем элемент с описанием, используя более гибкий поиск
  var descElements = document.querySelectorAll('.brand-desc-text');
  var desc = null;
  
  for (var i = 0; i < descElements.length; i++) {
    var elementBrand = descElements[i].getAttribute('data-brand');
    if (elementBrand === brand) {
      desc = descElements[i];
      break;
    }
  }
  
  var content = '';
  if (desc && desc.innerHTML.trim() !== '') {
    content = desc.innerHTML;
  } else {
    content = '<p style="color: #666; font-style: italic;">Описание бренда отсутствует</p>';
  }
  document.getElementById('brandDescModalContent').innerHTML = content;
  document.getElementById('brandDescModal').style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
  // Добавляем обработчики при загрузке страницы
  addBrandDescHandlers();
  
  // Функция для применения фильтров
  function applyFilters() {
    const selectedBrand = document.getElementById('brandFilter').value;
    const selectedRating = document.getElementById('ratingFilter').value;
    const selectedPrice = document.getElementById('priceFilter').value;
    const tableRows = document.querySelectorAll('.offers-table tbody tr');
    
    console.log('=== FILTER DEBUG START ===');
    console.log('Selected filters:', {
      brand: selectedBrand,
      rating: selectedRating,
      price: selectedPrice
    });
    console.log('Total rows found:', tableRows.length);
    
    // Проверяем каждый ряд отдельно
    tableRows.forEach(function(row, index) {
      const brandCell = row.querySelector('td:nth-child(2)'); // Колонка "Бренд"
      
      console.log(`Row ${index}:`, {
        hasBrandCell: !!brandCell,
        brandText: brandCell ? brandCell.textContent.trim() : 'N/A'
      });
      
      if (brandCell) {
        const brandText = brandCell.textContent.trim();
        const brandName = brandText.split('\n')[0].trim(); // Берем только название бренда
        
        // Проверяем фильтр по бренду
        let brandMatch = selectedBrand === '' || brandName === selectedBrand;
        
        // Проверяем фильтр по рейтингу
        let ratingMatch = true;
        if (selectedRating !== '') {
          const ratingStars = brandCell.querySelector('span[style*="color"]');
          if (ratingStars) {
            const starText = ratingStars.textContent;
            const filledStars = (starText.match(/★/g) || []).length;
            const emptyStars = (starText.match(/☆/g) || []).length;
            const totalStars = filledStars + emptyStars;
            const rating = totalStars - emptyStars; // Рейтинг = заполненные звезды
            ratingMatch = rating === parseInt(selectedRating);
          } else {
            ratingMatch = false; // Если нет звезд, то не подходит под рейтинг
          }
        }
        
        // Проверяем фильтр по цене
        let priceMatch = true;
        if (selectedPrice !== '') {
          const priceCell = row.querySelector('td:nth-child(7)'); // Колонка "Цена"
          if (priceCell) {
            const priceText = priceCell.textContent.trim();
            const priceRegex = priceText.match(/(\d+(?:\.\d+)?)/);
            if (priceRegex) {
              const rowPrice = parseFloat(priceRegex[1]);
              const selectedPriceNum = parseFloat(selectedPrice);
              priceMatch = rowPrice === selectedPriceNum;
            } else {
              priceMatch = false;
            }
          } else {
            priceMatch = false;
          }
        }
        

        
        // Показываем/скрываем строку в зависимости от фильтров
        // Фильтры работают независимо друг от друга
        let shouldShow = false;
        
        // Если не выбран ни один фильтр, показываем все
        if (selectedBrand === '' && selectedRating === '' && selectedPrice === '') {
          shouldShow = true;
        } else {
          // Проверяем каждый фильтр отдельно
          if (selectedBrand !== '' && brandMatch) {
            shouldShow = true;
          }
          if (selectedRating !== '' && ratingMatch) {
            shouldShow = true;
          }
          if (selectedPrice !== '' && priceMatch) {
            shouldShow = true;
          }
        }
        
        if (shouldShow) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
        
        console.log(`Row ${index} final result:`, {
          brandMatch,
          ratingMatch,
          priceMatch,
          shouldShow,
          display: shouldShow ? 'show' : 'hide',
          selectedBrand,
          selectedRating,
          selectedPrice
        });
      } else {
        // Для строк без бренда (кнопки, заголовки) проверяем соседние строки
        const prevRow = row.previousElementSibling;
        const nextRow = row.nextElementSibling;
        let shouldShow = selectedBrand === '' && selectedRating === '' && selectedPrice === ''; // По умолчанию показываем только если выбраны все фильтры
        
        if (prevRow) {
          const prevBrandCell = prevRow.querySelector('td:nth-child(2)');
          if (prevBrandCell) {
            const prevBrandText = prevBrandCell.textContent.trim();
            const prevBrandName = prevBrandText.split('\n')[0].trim();
            // Проверяем, есть ли видимые строки в предыдущей группе
            let hasVisibleRows = false;
            let currentRow = prevRow;
            while (currentRow && currentRow.querySelector('td:nth-child(2)') && 
                   currentRow.querySelector('td:nth-child(2)').textContent.trim().split('\n')[0].trim() === prevBrandName) {
              if (currentRow.style.display !== 'none') {
                hasVisibleRows = true;
                break;
              }
              currentRow = currentRow.previousElementSibling;
            }
            if (hasVisibleRows) {
              shouldShow = true;
            }
          }
        }
        
        if (nextRow && !shouldShow) {
          const nextBrandCell = nextRow.querySelector('td:nth-child(2)');
          if (nextBrandCell) {
            const nextBrandText = nextBrandCell.textContent.trim();
            const nextBrandName = nextBrandText.split('\n')[0].trim();
            // Проверяем, есть ли видимые строки в следующей группе
            let hasVisibleRows = false;
            let currentRow = nextRow;
            while (currentRow && currentRow.querySelector('td:nth-child(2)') && 
                   currentRow.querySelector('td:nth-child(2)').textContent.trim().split('\n')[0].trim() === nextBrandName) {
              if (currentRow.style.display !== 'none') {
                hasVisibleRows = true;
                break;
              }
              currentRow = currentRow.nextElementSibling;
            }
            if (hasVisibleRows) {
              shouldShow = true;
            }
          }
        }
        
        row.style.display = shouldShow ? '' : 'none';
      }
    });
  }

  // Обработчики для фильтров
  const brandFilter = document.getElementById('brandFilter');
  const ratingFilter = document.getElementById('ratingFilter');
  const priceFilter = document.getElementById('priceFilter');
  
  if (brandFilter) {
    brandFilter.addEventListener('change', applyFilters);
  }
  
  if (ratingFilter) {
    ratingFilter.addEventListener('change', applyFilters);
  }
  
  if (priceFilter) {
    priceFilter.addEventListener('change', applyFilters);
  }
  
  document.getElementById('brandDescModalClose').onclick = function() {
    document.getElementById('brandDescModal').style.display = 'none';
  };
  document.getElementById('brandDescModal').onclick = function(e) {
    if (e.target === this) this.style.display = 'none';
  };
});
</script>
{% endblock %}
