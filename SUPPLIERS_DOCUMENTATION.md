# Система поставщиков ShopApex - Техническая документация

## Обзор реализации

Система поставщиков полностью реализована согласно техническому заданию "Фантома". Добавлена комплексная функциональность для управления поставщиками, интеграции с внешними API и синхронизации товаров.

## Реализованные компоненты

### 1. Модели данных

#### Supplier (Поставщик)
- **Основная информация**: название, описание, контактные данные
- **API настройки**: URL, ключи, формат данных, частота синхронизации
- **Настройки товаров**: наценка, автоактивация, маппинг категорий
- **Методы**: `test_api_connection()`, `sync_products()`

#### SupplierProduct (Товар поставщика)
- **Информация о товаре**: артикул поставщика, название, цена, количество
- **Связь с каталогом**: опциональная связь с Product
- **Оригинальные данные**: JSON поле для хранения всех данных от API
- **Методы**: `create_catalog_product()` для создания товара в каталоге

#### SupplierSyncLog (Лог синхронизации)
- **Статус синхронизации**: в процессе, завершено, ошибка
- **Статистика**: количество созданных/обновленных товаров, ошибок
- **Детали**: сообщение об ошибке или успехе

### 2. API (Django REST Framework)

#### Endpoints

- `GET/POST /api/catalog/suppliers/` - Список/создание поставщиков
- `GET/PUT/PATCH/DELETE /api/catalog/suppliers/{id}/` - Детали поставщика
- `POST /api/catalog/suppliers/{id}/test_api/` - Тест API подключения
- `POST /api/catalog/suppliers/{id}/sync_products/` - Синхронизация товаров
- `GET /api/catalog/suppliers/{id}/products/` - Товары поставщика
- `GET /api/catalog/suppliers/{id}/sync_logs/` - Логи синхронизации

- `GET/POST /api/catalog/supplier-products/` - Товары поставщиков
- `POST /api/catalog/supplier-products/{id}/create_product/` - Создание товара в каталоге

- `GET /api/catalog/supplier-logs/` - Логи синхронизации

#### Особенности API
- Права доступа только для администраторов
- Фильтрация и пагинация
- Подробная обработка ошибок
- Валидация данных

### 3. Административная панель

#### Расширенная админка для поставщиков
- **Список поставщиков** с кнопками действий
- **Кнопки управления**: "Тест API", "Синхронизация", "Товары"
- **Статус API** в реальном времени
- **Инлайн редактирование** товаров поставщика

#### Управление товарами поставщиков
- **Просмотр товаров** с связью на каталог
- **Создание товаров** в каталоге одной кнопкой
- **Фильтрация** по статусу связи с каталогом
- **Массовые операции**

#### Логи синхронизации
- **История операций** с полной детализацией
- **Фильтрация по статусу** и поставщику
- **Автоматическая запись** всех операций

### 4. Веб-интерфейс

#### Страницы для администраторов

**Список поставщиков** (`/catalog/suppliers/`)
- Карточки поставщиков с основной информацией
- Статус API и последней синхронизации
- Поиск и фильтрация
- Кнопки быстрых действий

**Детали поставщика** (`/catalog/supplier/{id}/`)
- Полная информация о поставщике
- Статистика по товарам
- Последние товары и логи
- API настройки и статус

**Товары поставщика** (`/catalog/supplier/{id}/products/`)
- Список всех товаров с детальной информацией
- Фильтрация по связи с каталогом
- Создание товаров в каталоге
- Отображение данных от API

### 5. Синхронизация с API

#### Функциональность
- **Автоматическое тестирование** подключения
- **Получение данных** в формате JSON
- **Парсинг и сохранение** товаров
- **Обновление существующих** товаров
- **Создание новых** товаров
- **Логирование всех операций**

#### Обработка ошибок
- **Таймауты соединения**
- **HTTP ошибки**
- **Неверный формат данных**
- **Отсутствующие обязательные поля**

#### Безопасность
- **Bearer Token авторизация**
- **Валидация SSL сертификатов**
- **Обработка исключений**

## Использование системы

### Для администраторов

1. **Добавление поставщика**
   - Зайти в админку `/admin/catalog/supplier/add/`
   - Заполнить основную информацию
   - Настроить API (URL, ключ, формат)
   - Установить параметры синхронизации

2. **Настройка API**
   - Указать URL API поставщика
   - Добавить ключ авторизации
   - Выбрать формат данных (JSON)
   - Настроить частоту синхронизации

3. **Тестирование подключения**
   - Нажать кнопку "Тест API" в списке поставщиков
   - Проверить статус подключения
   - Просмотреть логи в случае ошибок

4. **Синхронизация товаров**
   - Нажать кнопку "Синхронизация"
   - Дождаться завершения процесса
   - Проверить логи синхронизации
   - Просмотреть добавленные товары

5. **Управление товарами**
   - Просмотреть товары поставщика
   - Создать товары в каталоге
   - Настроить маппинг категорий и брендов
   - Управлять ценами и наценками

### API интеграция

#### Формат данных от поставщика

```json
{
  "products": [
    {
      "article": "BP-001",
      "name": "Тормозные колодки передние Toyota Camry",
      "price": 2500.00,
      "stock": 25,
      "brand": "Toyota",
      "model": "Camry",
      "year": "2018-2023",
      "description": "Оригинальные тормозные колодки",
      "weight": "1.2 кг",
      "warranty": "12 месяцев"
    }
  ]
}
```

#### Пример использования API

```python
# Тест подключения
POST /api/catalog/suppliers/1/test_api/
{
  "success": true,
  "message": "Соединение успешно"
}

# Синхронизация товаров
POST /api/catalog/suppliers/1/sync_products/
{
  "success": true,
  "message": "Синхронизация завершена",
  "products_created": 5,
  "products_updated": 12,
  "errors_count": 0
}
```

## Тестовые данные

Система поставляется с тестовыми данными:

- **3 поставщика** с различными настройками
- **7 товаров поставщиков** с реальными данными
- **Логи синхронизации** с примерами успеха и ошибок

Для загрузки тестовых данных выполните:
```bash
python load_suppliers_data.py
```

## Файловая структура

```
catalog/
├── models.py              # Модели Supplier, SupplierProduct, SupplierSyncLog
├── admin.py               # Расширенная админка с кнопками
├── views.py               # API ViewSets
├── web_views.py           # Веб-представления для администраторов
├── serializers.py         # DRF сериализаторы
├── urls.py                # API маршруты
└── web_urls.py            # Веб-маршруты

templates/catalog/suppliers/
├── list.html              # Список поставщиков
├── detail.html            # Детали поставщика
└── products.html          # Товары поставщика

load_suppliers_data.py     # Скрипт загрузки тестовых данных
```

## Технические особенности

### Производительность
- **select_related/prefetch_related** для оптимизации запросов
- **Пагинация** для больших списков
- **Индексы** на часто запрашиваемые поля
- **Кэширование** статистики

### Безопасность
- **Проверка прав доступа** только для администраторов
- **CSRF защита** для форм
- **Валидация данных** на уровне модели
- **Безопасные HTTP запросы**

### Масштабируемость
- **Модульная архитектура**
- **Разделение API и веб-интерфейса**
- **Готовность к Celery** для фоновых задач
- **Поддержка множественных форматов** данных

## Следующие шаги

1. **Автоматическая синхронизация** через Celery и Redis
2. **Поддержка XML и CSV** форматов
3. **Расширенный маппинг** категорий и брендов
4. **Уведомления** об ошибках синхронизации
5. **Метрики и аналитика** работы с поставщиками

## Контакты и поддержка

Для вопросов по системе поставщиков обращайтесь к техническому специалисту "Фантому" - разработчику данной функциональности.

---

**Статус:** ✅ Полностью реализовано согласно ТЗ  
**Дата:** 7 июля 2025 г.  
**Версия:** 1.0.0
